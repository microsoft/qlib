# Qlib Web 平台 UI/UX 优化方案设计文档

**(基于方案二：模块化与上下文关联)**

## 1. 目标与哲学

*   **目标**: 构建一个直观、易用且功能强大的 Web UI，用于管理 Qlib 量化策略的整个生命周期，从模型训练到策略配置、回测和实盘部署。
*   **核心哲学 (方案二)**:
    *   **模块化**: 明确区分**模型管理** (负责训练和评估预测模型) 和**策略管理** (负责定义如何使用模型信号进行交易决策)。
    *   **上下文关联**: 在 UI 的各个环节清晰地展示和利用关键上下文信息（如模型的训练周期、股票池、特征等），帮助用户做出明智决策。
    *   **智能引导**: 提供合理的默认值，减少用户输入负担，并引导用户遵循最佳实践。
    *   **风险提示**: 在可能导致结果不可靠或策略失效的操作前（如训练/执行宇宙不匹配），提供明确警告。

## 2. 模块设计详解

### 2.1. 模型管理 (Model Management)

*   **目的**: 创建、训练、管理和评估用于预测的机器学习模型。产出可供策略使用的"已训练模型"。
*   **主要页面**:
    *   **`models.html` (模型列表页)**:
        *   **功能**: 展示所有已创建的模型及其状态和关键信息。提供新建模型入口。
        *   **表格列**:
            *   名称
            *   类型 (LightGBM, LSTM, ...)
            *   **训练周期** (例如: "2018-01-01 - 2022-12-31")
            *   **训练股票池** (例如: "CSI 300")
            *   **特征集** (例如: "Alpha158", 使用 `truncate` 显示，`title` 显示完整内容)
            *   **标签** (例如: "Ref($close,-2)/Ref($close,-1)-1", 使用 `truncate` 显示，`title` 显示完整内容)
            *   状态 (草稿, 训练中..., 已训练, 失败)
            *   创建时间
            *   操作 (详情/编辑, 训练/重新训练, 删除, 取消训练等，根据状态显示不同按钮)
    *   **`create_model.html` (新建模型页)**:
        *   **功能**: 配置并启动一个新的模型训练任务。
        *   **卡片/区域**:
            *   **基本信息**: 模型名称 (必填), 模型描述。
            *   **模型定义与训练上下文 (Model Definition & Training Context - 整合自原"训练配置"、"模型配置"和"数据配置")**:
                *   **模型类型与参数**: 模型类型 (必填, `select`), 模型参数 (常用输入或高级 YAML/JSON)。
                *   **数据与训练设定**: 数据源 (必填, `select`), 数据频率 (必填, `select`), 训练股票池 (必填, `select`/`text`), 所用特征集 (必填, `textarea`), 标签/预测目标 (必填, `text`), 训练/验证/测试时间段 (必填, `date` * 6)。
        *   **操作按钮**: 取消, 保存草稿, **保存并开始训练**。
    *   **`edit_model.html` (编辑/详情页)**:
        *   **功能**: 查看模型详细配置、训练状态、训练日志（未来）、评估结果（未来），并可编辑配置（对于草稿状态）或触发重新训练。
        *   **内容**: 包含与 `create_model.html` 类似的"**基本信息**"和"**模型定义与训练上下文**"区域（根据状态可能只读），并增加显示训练日志、状态详情、模型评估指标等区域。
*   **关键记录数据 (模型元数据)**: 对于每个模型，后端需记录：名称、描述、模型类型、模型参数、**数据源**、**数据频率**、**训练开始/结束日期**、**训练股票池**、**特征集**、**标签配置**、训练状态、创建/更新时间、指向训练好的模型文件的指针、训练日志路径、评估结果等。

### 2.2. 策略管理 (Strategy Management)

*   **目的**: 定义如何利用一个"已训练模型"的信号来构建和执行交易策略。
*   **主要页面**:
    *   **`strategies.html` (策略列表页)**:
        *   **功能**: 展示所有已创建的策略配置及其运行状态（如果有）。提供新建策略入口和执行操作。
        *   **表格列**:
            *   名称
            *   状态 (草稿, 回测中, 实盘运行中, 已停止等)
            *   关联模型 (例如: "LSTM Alpha158")
            *   关键回测指标 (例如: 年化收益, 最大回撤 - *来自最近一次成功回测*)
            *   创建/更新日期
            *   操作 (详情, **运行回测 (按钮)**, **提交实盘 (按钮)**, 编辑 (草稿状态), 停止等)
    *   **`create_strategy.html` (新建策略页)**:
        *   **功能**: 创建一个策略配置实例，核心是"选择一个已训练模型"并"定义如何使用其信号"。
        *   **卡片/区域**:
            *   **基本信息**: 策略名称 (必填), 策略描述。
            *   **选择模型**:
                *   下拉框 (`select`, 必填) **只显示状态为"已训练"的模型** (需后端配合)。
                *   下方区域 (`#selected_model_info`) **显著展示选中模型的关键训练上下文**: 训练周期, 训练股票池, 特征集, 标签。
            *   **回测配置 (Backtest Configuration - 新增于此页面)**:
                *   回测时段 (必填, `date` * 2, 开始/结束日期)。
                *   回测基准 (可选, `select`)。
                *   回测股票池 (可选, `text`, 默认为模型训练池)。
            *   **组合策略配置 (Portfolio Strategy Configuration)**:
                *   组合策略类型 (必填, `select`, TopkDropoutStrategy, WeightStrategy, ...)
                *   策略参数 (根据类型动态显示常用参数输入，或提供高级 YAML/JSON 配置入口)
                *   交易成本 (手续费率, 滑点)。
        *   **操作按钮**: 取消, 保存草稿, **开始回测**。

### 2.3. 执行与结果 (Execution & Results)

*   **目的**: 基于一个已定义的策略配置，设置具体的执行参数（时间、范围、资金）来运行回测或提交实盘，并查看结果。
*   **主要组件/页面**:
    *   **运行回测模态框 (在 `strategies.html` 触发)**:
        *   **(注意：由于回测参数（时段、基准、股票池）已移至 `create_strategy.html` 页面配置，此"运行回测模态框"的设计及其触发逻辑需要重新审视。可能不再需要在此处收集参数，或者 `create_strategy.html` 保存的是一个包含完整回测设置的策略实例。)**
        *   **触发**: 点击策略列表行的"运行回测"按钮。
        *   **参数**:
            *   回测开始日期 (必填, `date`) - **默认值**: 根据策略关联模型的训练结束日期自动计算下一天。
            *   回测结束日期 (必填, `date`) - 默认值: 空。
            *   初始资金 (必填, `number`) - 默认值: 例如 1,000,000。
            *   基准 (可选, `text`)。
            *   **股票池/Universe** (必填, `select`) - **默认值**: 根据策略关联模型的训练股票池自动选中。
        *   **警告**: 如果用户修改了股票池，导致与模型训练股票池不一致，**点击"开始回测"时弹出 `confirm` 警告**。
        *   **操作**: 开始回测 (触发后端任务), 取消。
    *   **提交实盘模态框 (在 `strategies.html` 触发)**:
        *   **触发**: 点击策略列表行的"提交实盘"按钮。
        *   **参数**:
            *   选择账户 (必填, `select`)。\
            *   分配类型 (固定金额/账户百分比, `radio`)。\
            *   金额/百分比 (必填, `number`)。\
            *   **股票池/Universe** (必填, `select`) - **默认值**: 根据策略关联模型的训练股票池自动选中。
        *   **警告**: 如果用户修改了股票池，导致与模型训练股票池不一致，**点击"提交至实盘"时弹出 `confirm` 警告**。
        *   **操作**: 提交至实盘 (触发后端任务), 取消。
    *   **`strategy_detail.html` (策略详情页)**:
        *   **功能**: 集中展示一个策略配置的详细信息以及其下所有相关的执行（回测/实盘）记录和结果。
        *   **内容区域**:
            *   **策略配置回顾**:
                *   策略名称、描述。
                *   **关联模型**: 显示模型名称，并提供链接到模型详情/编辑页 (`edit_model.html`)。
                *   **组合策略**: 显示类型和参数。
                *   **交易成本**: 显示费率和滑点。
            *   **执行记录列表 (关键部分)**:
                *   以表格或卡片列表形式展示**每一次**基于此策略配置运行的回测或实盘实例。
                *   每条记录包含：
                    *   执行类型 (回测/实盘)。
                    *   **执行参数**: 开始日期, 结束日期, 初始资金, 基准, **股票池/Universe**。
                    *   执行状态 (运行中, 已完成, 失败)。
                    *   **关键结果指标** (年化收益, 最大回撤, Sharpe 等)。
                    *   操作 (查看详细报告/日志, 停止实盘等)。
                *   提供触发"运行新回测"（类似列表页弹窗）或"提交新实盘"的入口。

## 3. 关键 UX 原则总结

*   **上下文感知**: 用户在选择模型、配置策略、执行回测/实盘时，都能看到相关的训练背景信息。
*   **智能默认**: 通过预填股票池和回测开始日期，简化用户操作，并鼓励一致性。
*   **风险缓解**: 对潜在的配置不匹配（尤其是 Universe 不匹配）进行明确警告，让用户确认风险。
*   **职责分离**: UI 结构清晰反映模型训练、策略定义、执行配置这三个不同阶段。
*   **记录与追溯**: 策略详情页汇集所有执行记录，方便比较不同参数下的回测结果或追踪实盘表现。

## 4. 后续步骤 (概要)

1.  **后端 API 设计**: 为前端提供数据（模型/策略列表及详情）、接收配置、触发后台任务（训练/回测/实盘）、查询任务状态和结果。
2.  **模型元数据存储**: 设计数据库表或文件结构来存储模型的完整配置和训练上下文。
3.  **动态数据加载**: 将前端的硬编码数据（模型列表、上下文、下拉选项）替换为通过 API 从后端获取。
4.  **后台任务管理**: 实现可靠的后台任务队列来处理耗时的训练和回测。
5.  **回测结果展示**: 设计 `strategy_detail.html` 中展示详细回测报告的组件（例如，使用图表库绘制收益曲线）。