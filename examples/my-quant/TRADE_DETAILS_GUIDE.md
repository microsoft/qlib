# äº¤æ˜“è¯¦æƒ…å¯è§†åŒ–åŠŸèƒ½è¯´æ˜

## ğŸ“Œ æ¦‚è¿°

æˆ‘å·²ç»ä¸ºä½ æ”¹è¿›äº† `plot_utils.py` ä¸­çš„äº¤æ˜“è¯¦æƒ…å¯è§†åŒ–åŠŸèƒ½ã€‚æ–°çš„ `plot_detailed_trades()` å‡½æ•°å¯ä»¥ï¼š

1. **æ˜¾ç¤ºæ¯ä¸ªæ—¶é—´ç‚¹çš„ç¡®åˆ‡äº¤æ˜“åŠ¨ä½œ** - åœ¨æ”¶ç›Šæ›²çº¿ä¸Šæ ‡è®°æ¯ä¸€ç¬”äº¤æ˜“
2. **å±•ç¤ºå¯¹åº”çš„è‚¡ç¥¨ä¿¡æ¯** - åŒ…æ‹¬ä¹°å…¥/å–å‡ºçš„å…·ä½“è‚¡ç¥¨ä»£ç å’Œäº¤æ˜“æ˜ç»†
3. **æä¾›è¯¦ç»†çš„ç»Ÿè®¡åˆ†æ** - åŒ…æ‹¬äº¤æ˜“é‡‘é¢åˆ†å¸ƒã€æœ€æ´»è·ƒè‚¡ç¥¨ã€äº¤æ˜“æ´»è·ƒåº¦çƒ­åŠ›å›¾ç­‰
4. **ç”ŸæˆCSVäº¤æ˜“æ˜ç»†è¡¨** - æ–¹ä¾¿è¿›ä¸€æ­¥åˆ†æ

## ğŸ¨ æ–°å¢å¯è§†åŒ–å†…å®¹

### å›¾è¡¨1ï¼šç´¯è®¡æ”¶ç›Šæ›²çº¿ + æ¯ç¬”äº¤æ˜“æ ‡è®°
- åœ¨æ”¶ç›Šæ›²çº¿ä¸Šç”¨ **ç»¿è‰²å‘ä¸Šç®­å¤´ (â–²)** æ ‡è®°ä¹°å…¥äº¤æ˜“æ—¥
- åœ¨æ”¶ç›Šæ›²çº¿ä¸Šç”¨ **çº¢è‰²å‘ä¸‹ç®­å¤´ (â–¼)** æ ‡è®°å–å‡ºäº¤æ˜“æ—¥
- å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°æ¯ä¸ªäº¤æ˜“æ—¥å‘ç”Ÿçš„åŠ¨ä½œ

### å›¾è¡¨2ï¼šæ¯æ—¥äº¤æ˜“è‚¡ç¥¨æ•°é‡
- æŸ±çŠ¶å›¾æ˜¾ç¤ºæ¯å¤©ä¹°å…¥å’Œå–å‡ºçš„è‚¡ç¥¨æ•°é‡
- ä¹°å…¥æ˜¾ç¤ºä¸ºæ­£å€¼ï¼ˆç»¿è‰²ï¼‰ï¼Œå–å‡ºæ˜¾ç¤ºä¸ºè´Ÿå€¼ï¼ˆçº¢è‰²ï¼‰

### å›¾è¡¨3ï¼šäº¤æ˜“é‡‘é¢åˆ†å¸ƒ
- ç›´æ–¹å›¾æ˜¾ç¤ºä¹°å…¥å’Œå–å‡ºäº¤æ˜“çš„é‡‘é¢åˆ†å¸ƒ
- å¸®åŠ©äº†è§£äº¤æ˜“è§„æ¨¡

### å›¾è¡¨4ï¼šæœ€æ´»è·ƒçš„äº¤æ˜“è‚¡ç¥¨ TOP 20
- æ¨ªå‘æŸ±çŠ¶å›¾æ˜¾ç¤ºäº¤æ˜“æ¬¡æ•°æœ€å¤šçš„20åªè‚¡ç¥¨
- å¯ä»¥çœ‹åˆ°å“ªäº›è‚¡ç¥¨è¢«é¢‘ç¹äº¤æ˜“

### å›¾è¡¨5ï¼šäº¤æ˜“æ´»è·ƒåº¦çƒ­åŠ›å›¾
- æŒ‰æœˆä»½å’Œæ˜ŸæœŸå‡ å±•ç¤ºäº¤æ˜“æ´»è·ƒåº¦
- å‘ç°äº¤æ˜“çš„æ—¶é—´è§„å¾‹

### å›¾è¡¨6ï¼šäº¤æ˜“ç»Ÿè®¡æ‘˜è¦
- æ€»äº¤æ˜“æ¬¡æ•°ã€ä¹°å…¥/å–å‡ºæ¬¡æ•°
- äº¤æ˜“è‚¡ç¥¨æ•°ã€äº¤æ˜“æ—¥æ•°
- å¹³å‡äº¤æ˜“é‡‘é¢ç­‰å…³é”®æŒ‡æ ‡

### CSVæ–‡ä»¶ï¼š06_trade_details.csv
åŒ…å«æ¯ç¬”äº¤æ˜“çš„è¯¦ç»†ä¿¡æ¯ï¼š
- `datetime`: äº¤æ˜“æ—¥æœŸ
- `instrument`: è‚¡ç¥¨ä»£ç 
- `action`: äº¤æ˜“åŠ¨ä½œï¼ˆBUY/SELLï¼‰
- `amount`: äº¤æ˜“è‚¡æ•°
- `price`: äº¤æ˜“ä»·æ ¼
- `weight`: æŒä»“æƒé‡

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1ï¼šè®­ç»ƒæ—¶è‡ªåŠ¨ç”Ÿæˆ
```bash
cd D:/Quant-qlib-official/examples/my-quant
python train.py train --config config.yaml
```

è®­ç»ƒå®Œæˆåä¼šè‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰å›¾è¡¨ï¼ŒåŒ…æ‹¬æ–°çš„äº¤æ˜“è¯¦æƒ…å›¾ã€‚

### æ–¹æ³•2ï¼šä¸ºå·²æœ‰å®éªŒé‡æ–°ç”Ÿæˆå›¾è¡¨
```bash
python train.py plot --experiment_name my-quant-LightGBM
```

æˆ–è€…æŒ‡å®šç‰¹å®šçš„ recorder IDï¼š
```bash
python train.py plot --recorder_id <ä½ çš„recorder_id>
```

### æ–¹æ³•3ï¼šåœ¨Pythonä»£ç ä¸­è°ƒç”¨
```python
import qlib
from pathlib import Path
from qlib.workflow import R
from plot_utils import plot_detailed_trades, get_plot_output_dir

# åˆå§‹åŒ–qlib
qlib.init(provider_uri="~/.qlib/qlib_data/cn_data", region="cn")

# è·å–recorder
recorder = R.get_recorder(experiment_name="my-quant-LightGBM")

# åŠ è½½æŠ¥å‘Šæ•°æ®
report_df = recorder.load_object("portfolio_analysis/report_normal_1day.pkl")

# ç”Ÿæˆå›¾è¡¨
output_dir = get_plot_output_dir(Path.cwd(), "my-experiment")
saved_files = plot_detailed_trades(recorder, report_df, output_dir, "Test ")

print(f"å›¾è¡¨å·²ä¿å­˜åˆ°: {saved_files['detailed_trades']}")
print(f"CSVå·²ä¿å­˜åˆ°: {saved_files['trades_csv']}")
```

## ğŸ“‚ è¾“å‡ºæ–‡ä»¶ä½ç½®

å›¾è¡¨å’ŒCSVæ–‡ä»¶ä¼šä¿å­˜åœ¨ï¼š
```
examples/my-quant/plots/<æ—¥æœŸ>/<å®éªŒåç§°>/
â”œâ”€â”€ 01_cumulative_returns.png
â”œâ”€â”€ 02_monthly_returns.png
â”œâ”€â”€ 03_ic_analysis.png
â”œâ”€â”€ 04_rank_ic_analysis.png
â”œâ”€â”€ 05_risk_metrics.png
â”œâ”€â”€ 06_detailed_trades.png       # â† æ–°çš„è¯¦ç»†äº¤æ˜“å›¾
â”œâ”€â”€ 06_trade_details.csv         # â† äº¤æ˜“æ˜ç»†CSV
â””â”€â”€ statistics.txt
```

## ğŸ’¡ ç¤ºä¾‹ï¼šæŸ¥çœ‹CSVä¸­çš„äº¤æ˜“è¯¦æƒ…

ç”ŸæˆCSVåï¼Œä½ å¯ä»¥ç”¨pandasæŸ¥çœ‹ï¼š

```python
import pandas as pd

trades = pd.read_csv('plots/2024-XX-XX/my-quant-LightGBM/06_trade_details.csv')

# æŸ¥çœ‹å‰10ç¬”äº¤æ˜“
print(trades.head(10))

# æŸ¥çœ‹ç‰¹å®šæ—¥æœŸçš„äº¤æ˜“
trades_on_date = trades[trades['datetime'] == '2020-01-15']
print(trades_on_date)

# æŸ¥çœ‹æŸåªè‚¡ç¥¨çš„æ‰€æœ‰äº¤æ˜“
stock_trades = trades[trades['instrument'] == 'SH600000']
print(stock_trades)

# ç»Ÿè®¡ä¹°å…¥å’Œå–å‡ºæ¬¡æ•°
print(trades['action'].value_counts())
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®æ¥æº
äº¤æ˜“è¯¦æƒ…æ¥è‡ª qlib recorder ä¸­çš„ `positions_normal_1day.pkl` æ–‡ä»¶ï¼Œé€šè¿‡æ¯”è¾ƒç›¸é‚»ä¸¤å¤©çš„æŒä»“å˜åŒ–æ¥è¯†åˆ«ä¹°å…¥å’Œå–å‡ºåŠ¨ä½œã€‚

### å…³é”®å‡½æ•°
1. `load_trade_details(recorder)` - ä»æŒä»“æ•°æ®ä¸­æå–äº¤æ˜“åŠ¨ä½œ
2. `plot_detailed_trades(recorder, report_df, output_dir, title_prefix)` - ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨

### ä¸æ—§å‡½æ•°çš„åŒºåˆ«
- **æ—§å‡½æ•°** `plot_trade_details()`: æ˜¾ç¤ºèšåˆçš„äº¤æ˜“ä¿¡å·ï¼ˆåŸºäºæ¢æ‰‹ç‡é˜ˆå€¼ï¼‰
- **æ–°å‡½æ•°** `plot_detailed_trades()`: æ˜¾ç¤ºæ¯ç¬”å…·ä½“çš„äº¤æ˜“åŠ¨ä½œå’Œè‚¡ç¥¨

## âš ï¸ æ³¨æ„äº‹é¡¹

1. å¿…é¡»å…ˆå®Œæˆè®­ç»ƒå’Œå›æµ‹ï¼Œç”Ÿæˆ `positions_normal_1day.pkl` æ–‡ä»¶
2. å¦‚æœæ²¡æœ‰æŒä»“æ•°æ®ï¼Œä¼šæ˜¾ç¤ºè­¦å‘Šå¹¶è·³è¿‡äº¤æ˜“è¯¦æƒ…å›¾ç”Ÿæˆ
3. CSVæ–‡ä»¶ä½¿ç”¨UTF-8ç¼–ç ï¼Œæ”¯æŒä¸­æ–‡è‚¡ç¥¨åç§°

## ğŸ“Š ç¤ºä¾‹è¾“å‡º

### æ§åˆ¶å°è¾“å‡º
```
âœ… äº¤æ˜“è¯¦æƒ…å›¾å’ŒCSVå·²ä¿å­˜
   - å›¾ç‰‡: D:/Quant-qlib-official/examples/my-quant/plots/2024-01-15/my-quant-LightGBM/06_detailed_trades.png
   - CSV: D:/Quant-qlib-official/examples/my-quant/plots/2024-01-15/my-quant-LightGBM/06_trade_details.csv
```

### äº¤æ˜“ç»Ÿè®¡ç¤ºä¾‹
```
ğŸ“Š äº¤æ˜“ç»Ÿè®¡æ‘˜è¦
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»äº¤æ˜“æ¬¡æ•°: 1,234
ä¹°å…¥æ¬¡æ•°: 617
å–å‡ºæ¬¡æ•°: 617

äº¤æ˜“è‚¡ç¥¨æ•°: 156
äº¤æ˜“æ—¥æ•°: 245
æ—¥å‡äº¤æ˜“æ•°: 5.0

å¹³å‡ä¹°å…¥é‡‘é¢: 45,678
å¹³å‡å–å‡ºé‡‘é¢: 46,123
```

## ğŸ¯ ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å¯ä»¥ï¼š
1. è¿è¡Œ `python train.py train` æ¥ç”Ÿæˆæ–°çš„äº¤æ˜“è¯¦æƒ…å›¾
2. æˆ–è€…è¿è¡Œ `python train.py plot` ä¸ºå·²æœ‰å®éªŒé‡æ–°ç”Ÿæˆå›¾è¡¨
3. æŸ¥çœ‹ç”Ÿæˆçš„ `06_detailed_trades.png` å›¾ç‰‡
4. åˆ†æ `06_trade_details.csv` æ–‡ä»¶ä¸­çš„å…·ä½“äº¤æ˜“æ˜ç»†

æœ‰ä»»ä½•é—®é¢˜æˆ–éœ€è¦è¿›ä¸€æ­¥è°ƒæ•´ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼
