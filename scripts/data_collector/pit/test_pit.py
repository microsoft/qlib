# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.
import pandas as pd

import qlib
from qlib.data import D
import unittest


class TestPIT(unittest.TestCase):
    """
    NOTE!!!!!!
    The assert of this test assumes that users follows the cmd below and only download 2 stock.
    1. `python scripts/get_data.py qlib_data --target_dir ~/.qlib/qlib_data/cn_data --region cn`
    2. `python scripts/data_collector/pit/collector.py download_data --source_dir ~/.qlib/stock_data/source/pit --start 2000-01-01 --end 2020-01-01 --interval quarterly --symbol_regex "^(600519|000725).*"`
    3. `python scripts/data_collector/pit/collector.py normalize_data --interval quarterly --source_dir ~/.qlib/stock_data/source/pit --normalize_dir ~/.qlib/stock_data/source/pit_normalized`
    4. `python scripts/dump_pit.py dump --csv_path ~/.qlib/stock_data/source/pit_normalized --qlib_dir ~/.qlib/qlib_data/cn_data --interval quarterly`
    """

    def setUp(self):
        # qlib.init(kernels=1)  # NOTE: set kernel to 1 to make it debug easier
        qlib.init()

    def to_str(self, obj):
        if isinstance(obj, pd.DataFrame):
            obj = obj.to_string()
        elif isinstance(obj, pd.Series):
            obj = str(obj)
        return "".join(obj.split())

    def check_same(self, a, b):
        self.assertEqual(self.to_str(a), self.to_str(b))

    def test_query(self):
        instruments = ["sh600519"]
        fields = ["P($$roewa_q)", "P($$yoyni_q)"]
        # Mao Tai published 2019Q2 report at 2019-07-13 & 2019-07-18
        # - http://www.cninfo.com.cn/new/commonUrl/pageOfSearch?url=disclosure/list/search&lastPage=index
        data = D.features(instruments, fields, start_time="2019-01-01", end_time="2019-07-19", freq="day")
        res = """
               P($$roewa_q)  P($$yoyni_q)
        count    133.000000    133.000000
        mean       0.196412      0.277930
        std        0.097591      0.030262
        min        0.000000      0.243892
        25%        0.094737      0.243892
        50%        0.255220      0.304181
        75%        0.255220      0.305041
        max        0.344644      0.305041
        """
        self.check_same(data.describe(), res)

        res = """
                               P($$roewa_q)  P($$yoyni_q)
        instrument datetime
        sh600519   2019-07-15      0.000000      0.305041
                   2019-07-16      0.000000      0.305041
                   2019-07-17      0.000000      0.305041
                   2019-07-18      0.175322      0.252650
                   2019-07-19      0.175322      0.252650
        """
        self.check_same(data.tail(), res)

    def test_no_exist_data(self):
        fields = ["P($$roewa_q)", "P($$yoyni_q)", "$close"]
        data = D.features(["sh600519", "sh601988"], fields, start_time="2019-01-01", end_time="20190719", freq="day")
        data["$close"] = 1  # in case of different dataset gives different values
        expect = """
                               P($$roewa_q)  P($$yoyni_q)  $close
        instrument datetime                                      
        sh600519   2019-01-02      0.255220      0.243892       1
                   2019-01-03      0.255220      0.243892       1
                   2019-01-04      0.255220      0.243892       1
                   2019-01-07      0.255220      0.243892       1
                   2019-01-08      0.255220      0.243892       1
                   2019-01-09      0.255220      0.243892       1
                   2019-01-10      0.255220      0.243892       1
                   2019-01-11      0.255220      0.243892       1
                   2019-01-14      0.255220      0.243892       1
                   2019-01-15      0.255220      0.243892       1
                   2019-01-16      0.255220      0.243892       1
                   2019-01-17      0.255220      0.243892       1
                   2019-01-18      0.255220      0.243892       1
                   2019-01-21      0.255220      0.243892       1
                   2019-01-22      0.255220      0.243892       1
                   2019-01-23      0.255220      0.243892       1
                   2019-01-24      0.255220      0.243892       1
                   2019-01-25      0.255220      0.243892       1
                   2019-01-28      0.255220      0.243892       1
                   2019-01-29      0.255220      0.243892       1
                   2019-01-30      0.255220      0.243892       1
                   2019-01-31      0.255220      0.243892       1
                   2019-02-01      0.255220      0.243892       1
                   2019-02-11      0.255220      0.243892       1
                   2019-02-12      0.255220      0.243892       1
                   2019-02-13      0.255220      0.243892       1
                   2019-02-14      0.255220      0.243892       1
                   2019-02-15      0.255220      0.243892       1
                   2019-02-18      0.255220      0.243892       1
                   2019-02-19      0.255220      0.243892       1
                   2019-02-20      0.255220      0.243892       1
                   2019-02-21      0.255220      0.243892       1
                   2019-02-22      0.255220      0.243892       1
                   2019-02-25      0.255220      0.243892       1
                   2019-02-26      0.255220      0.243892       1
                   2019-02-27      0.255220      0.243892       1
                   2019-02-28      0.255220      0.243892       1
                   2019-03-01      0.255220      0.243892       1
                   2019-03-04      0.255220      0.243892       1
                   2019-03-05      0.255220      0.243892       1
                   2019-03-06      0.255220      0.243892       1
                   2019-03-07      0.255220      0.243892       1
                   2019-03-08      0.255220      0.243892       1
                   2019-03-11      0.255220      0.243892       1
                   2019-03-12      0.255220      0.243892       1
                   2019-03-13      0.255220      0.243892       1
                   2019-03-14      0.255220      0.243892       1
                   2019-03-15      0.255220      0.243892       1
                   2019-03-18      0.255220      0.243892       1
                   2019-03-19      0.255220      0.243892       1
                   2019-03-20      0.255220      0.243892       1
                   2019-03-21      0.255220      0.243892       1
                   2019-03-22      0.255220      0.243892       1
                   2019-03-25      0.255220      0.243892       1
                   2019-03-26      0.255220      0.243892       1
                   2019-03-27      0.255220      0.243892       1
                   2019-03-28      0.255220      0.243892       1
                   2019-03-29      0.344644      0.304181       1
                   2019-04-01      0.344644      0.304181       1
                   2019-04-02      0.344644      0.304181       1
                   2019-04-03      0.344644      0.304181       1
                   2019-04-04      0.344644      0.304181       1
                   2019-04-08      0.344644      0.304181       1
                   2019-04-09      0.344644      0.304181       1
                   2019-04-10      0.344644      0.304181       1
                   2019-04-11      0.344644      0.304181       1
                   2019-04-12      0.344644      0.304181       1
                   2019-04-15      0.344644      0.304181       1
                   2019-04-16      0.344644      0.304181       1
                   2019-04-17      0.344644      0.304181       1
                   2019-04-18      0.344644      0.304181       1
                   2019-04-19      0.344644      0.304181       1
                   2019-04-22      0.344644      0.304181       1
                   2019-04-23      0.344644      0.304181       1
                   2019-04-24      0.344644      0.304181       1
                   2019-04-25      0.094737      0.305041       1
                   2019-04-26      0.094737      0.305041       1
                   2019-04-29      0.094737      0.305041       1
                   2019-04-30      0.094737      0.305041       1
                   2019-05-06      0.094737      0.305041       1
                   2019-05-07      0.094737      0.305041       1
                   2019-05-08      0.094737      0.305041       1
                   2019-05-09      0.094737      0.305041       1
                   2019-05-10      0.094737      0.305041       1
                   2019-05-13      0.094737      0.305041       1
                   2019-05-14      0.094737      0.305041       1
                   2019-05-15      0.094737      0.305041       1
                   2019-05-16      0.094737      0.305041       1
                   2019-05-17      0.094737      0.305041       1
                   2019-05-20      0.094737      0.305041       1
                   2019-05-21      0.094737      0.305041       1
                   2019-05-22      0.094737      0.305041       1
                   2019-05-23      0.094737      0.305041       1
                   2019-05-24      0.094737      0.305041       1
                   2019-05-27      0.094737      0.305041       1
                   2019-05-28      0.094737      0.305041       1
                   2019-05-29      0.094737      0.305041       1
                   2019-05-30      0.094737      0.305041       1
                   2019-05-31      0.094737      0.305041       1
                   2019-06-03      0.094737      0.305041       1
                   2019-06-04      0.094737      0.305041       1
                   2019-06-05      0.094737      0.305041       1
                   2019-06-06      0.094737      0.305041       1
                   2019-06-10      0.094737      0.305041       1
                   2019-06-11      0.094737      0.305041       1
                   2019-06-12      0.094737      0.305041       1
                   2019-06-13      0.094737      0.305041       1
                   2019-06-14      0.094737      0.305041       1
                   2019-06-17      0.094737      0.305041       1
                   2019-06-18      0.094737      0.305041       1
                   2019-06-19      0.094737      0.305041       1
                   2019-06-20      0.094737      0.305041       1
                   2019-06-21      0.094737      0.305041       1
                   2019-06-24      0.094737      0.305041       1
                   2019-06-25      0.094737      0.305041       1
                   2019-06-26      0.094737      0.305041       1
                   2019-06-27      0.094737      0.305041       1
                   2019-06-28      0.094737      0.305041       1
                   2019-07-01      0.094737      0.305041       1
                   2019-07-02      0.094737      0.305041       1
                   2019-07-03      0.094737      0.305041       1
                   2019-07-04      0.094737      0.305041       1
                   2019-07-05      0.094737      0.305041       1
                   2019-07-08      0.094737      0.305041       1
                   2019-07-09      0.094737      0.305041       1
                   2019-07-10      0.094737      0.305041       1
                   2019-07-11      0.094737      0.305041       1
                   2019-07-12      0.094737      0.305041       1
                   2019-07-15      0.000000      0.305041       1
                   2019-07-16      0.000000      0.305041       1
                   2019-07-17      0.000000      0.305041       1
                   2019-07-18      0.175322      0.252650       1
                   2019-07-19      0.175322      0.252650       1
        sh601988   2019-01-02           NaN           NaN       1
                   2019-01-03           NaN           NaN       1
                   2019-01-04           NaN           NaN       1
                   2019-01-07           NaN           NaN       1
                   2019-01-08           NaN           NaN       1
                   2019-01-09           NaN           NaN       1
                   2019-01-10           NaN           NaN       1
                   2019-01-11           NaN           NaN       1
                   2019-01-14           NaN           NaN       1
                   2019-01-15           NaN           NaN       1
                   2019-01-16           NaN           NaN       1
                   2019-01-17           NaN           NaN       1
                   2019-01-18           NaN           NaN       1
                   2019-01-21           NaN           NaN       1
                   2019-01-22           NaN           NaN       1
                   2019-01-23           NaN           NaN       1
                   2019-01-24           NaN           NaN       1
                   2019-01-25           NaN           NaN       1
                   2019-01-28           NaN           NaN       1
                   2019-01-29           NaN           NaN       1
                   2019-01-30           NaN           NaN       1
                   2019-01-31           NaN           NaN       1
                   2019-02-01           NaN           NaN       1
                   2019-02-11           NaN           NaN       1
                   2019-02-12           NaN           NaN       1
                   2019-02-13           NaN           NaN       1
                   2019-02-14           NaN           NaN       1
                   2019-02-15           NaN           NaN       1
                   2019-02-18           NaN           NaN       1
                   2019-02-19           NaN           NaN       1
                   2019-02-20           NaN           NaN       1
                   2019-02-21           NaN           NaN       1
                   2019-02-22           NaN           NaN       1
                   2019-02-25           NaN           NaN       1
                   2019-02-26           NaN           NaN       1
                   2019-02-27           NaN           NaN       1
                   2019-02-28           NaN           NaN       1
                   2019-03-01           NaN           NaN       1
                   2019-03-04           NaN           NaN       1
                   2019-03-05           NaN           NaN       1
                   2019-03-06           NaN           NaN       1
                   2019-03-07           NaN           NaN       1
                   2019-03-08           NaN           NaN       1
                   2019-03-11           NaN           NaN       1
                   2019-03-12           NaN           NaN       1
                   2019-03-13           NaN           NaN       1
                   2019-03-14           NaN           NaN       1
                   2019-03-15           NaN           NaN       1
                   2019-03-18           NaN           NaN       1
                   2019-03-19           NaN           NaN       1
                   2019-03-20           NaN           NaN       1
                   2019-03-21           NaN           NaN       1
                   2019-03-22           NaN           NaN       1
                   2019-03-25           NaN           NaN       1
                   2019-03-26           NaN           NaN       1
                   2019-03-27           NaN           NaN       1
                   2019-03-28           NaN           NaN       1
                   2019-03-29           NaN           NaN       1
                   2019-04-01           NaN           NaN       1
                   2019-04-02           NaN           NaN       1
                   2019-04-03           NaN           NaN       1
                   2019-04-04           NaN           NaN       1
                   2019-04-08           NaN           NaN       1
                   2019-04-09           NaN           NaN       1
                   2019-04-10           NaN           NaN       1
                   2019-04-11           NaN           NaN       1
                   2019-04-12           NaN           NaN       1
                   2019-04-15           NaN           NaN       1
                   2019-04-16           NaN           NaN       1
                   2019-04-17           NaN           NaN       1
                   2019-04-18           NaN           NaN       1
                   2019-04-19           NaN           NaN       1
                   2019-04-22           NaN           NaN       1
                   2019-04-23           NaN           NaN       1
                   2019-04-24           NaN           NaN       1
                   2019-04-25           NaN           NaN       1
                   2019-04-26           NaN           NaN       1
                   2019-04-29           NaN           NaN       1
                   2019-04-30           NaN           NaN       1
                   2019-05-06           NaN           NaN       1
                   2019-05-07           NaN           NaN       1
                   2019-05-08           NaN           NaN       1
                   2019-05-09           NaN           NaN       1
                   2019-05-10           NaN           NaN       1
                   2019-05-13           NaN           NaN       1
                   2019-05-14           NaN           NaN       1
                   2019-05-15           NaN           NaN       1
                   2019-05-16           NaN           NaN       1
                   2019-05-17           NaN           NaN       1
                   2019-05-20           NaN           NaN       1
                   2019-05-21           NaN           NaN       1
                   2019-05-22           NaN           NaN       1
                   2019-05-23           NaN           NaN       1
                   2019-05-24           NaN           NaN       1
                   2019-05-27           NaN           NaN       1
                   2019-05-28           NaN           NaN       1
                   2019-05-29           NaN           NaN       1
                   2019-05-30           NaN           NaN       1
                   2019-05-31           NaN           NaN       1
                   2019-06-03           NaN           NaN       1
                   2019-06-04           NaN           NaN       1
                   2019-06-05           NaN           NaN       1
                   2019-06-06           NaN           NaN       1
                   2019-06-10           NaN           NaN       1
                   2019-06-11           NaN           NaN       1
                   2019-06-12           NaN           NaN       1
                   2019-06-13           NaN           NaN       1
                   2019-06-14           NaN           NaN       1
                   2019-06-17           NaN           NaN       1
                   2019-06-18           NaN           NaN       1
                   2019-06-19           NaN           NaN       1
                   2019-06-20           NaN           NaN       1
                   2019-06-21           NaN           NaN       1
                   2019-06-24           NaN           NaN       1
                   2019-06-25           NaN           NaN       1
                   2019-06-26           NaN           NaN       1
                   2019-06-27           NaN           NaN       1
                   2019-06-28           NaN           NaN       1
                   2019-07-01           NaN           NaN       1
                   2019-07-02           NaN           NaN       1
                   2019-07-03           NaN           NaN       1
                   2019-07-04           NaN           NaN       1
                   2019-07-05           NaN           NaN       1
                   2019-07-08           NaN           NaN       1
                   2019-07-09           NaN           NaN       1
                   2019-07-10           NaN           NaN       1
                   2019-07-11           NaN           NaN       1
                   2019-07-12           NaN           NaN       1
                   2019-07-15           NaN           NaN       1
                   2019-07-16           NaN           NaN       1
                   2019-07-17           NaN           NaN       1
                   2019-07-18           NaN           NaN       1
                   2019-07-19           NaN           NaN       1
        """
        self.check_same(data, expect)

    def test_expr(self):
        fields = [
            "P(Mean($$roewa_q, 1))",
            "P($$roewa_q)",
            "P(Mean($$roewa_q, 2))",
            "P(Ref($$roewa_q, 1))",
            "P((Ref($$roewa_q, 1) +$$roewa_q) / 2)",
        ]
        instruments = ["sh600519"]
        data = D.features(instruments, fields, start_time="2019-01-01", end_time="20190719", freq="day")
        expect = """
                               P(Mean($$roewa_q, 1))  P($$roewa_q)  P(Mean($$roewa_q, 2))  P(Ref($$roewa_q, 1))  P((Ref($$roewa_q, 1) +$$roewa_q) / 2)
        instrument datetime
        sh600519   2019-07-01               0.094737      0.094737               0.219691              0.344644                               0.219691
                   2019-07-02               0.094737      0.094737               0.219691              0.344644                               0.219691
                   2019-07-03               0.094737      0.094737               0.219691              0.344644                               0.219691
                   2019-07-04               0.094737      0.094737               0.219691              0.344644                               0.219691
                   2019-07-05               0.094737      0.094737               0.219691              0.344644                               0.219691
                   2019-07-08               0.094737      0.094737               0.219691              0.344644                               0.219691
                   2019-07-09               0.094737      0.094737               0.219691              0.344644                               0.219691
                   2019-07-10               0.094737      0.094737               0.219691              0.344644                               0.219691
                   2019-07-11               0.094737      0.094737               0.219691              0.344644                               0.219691
                   2019-07-12               0.094737      0.094737               0.219691              0.344644                               0.219691
                   2019-07-15               0.000000      0.000000               0.047369              0.094737                               0.047369
                   2019-07-16               0.000000      0.000000               0.047369              0.094737                               0.047369
                   2019-07-17               0.000000      0.000000               0.047369              0.094737                               0.047369
                   2019-07-18               0.175322      0.175322               0.135029              0.094737                               0.135029
                   2019-07-19               0.175322      0.175322               0.135029              0.094737                               0.135029
        """
        self.check_same(data.tail(15), expect)

    def test_unlimit(self):
        # fields = ["P(Mean($$roewa_q, 1))", "P($$roewa_q)", "P(Mean($$roewa_q, 2))", "P(Ref($$roewa_q, 1))", "P((Ref($$roewa_q, 1) +$$roewa_q) / 2)"]
        fields = ["P($$roewa_q)"]
        instruments = ["sh600519"]
        _ = D.features(instruments, fields, freq="day")  # this should not raise error
        data = D.features(instruments, fields, end_time="2020-01-01", freq="day")  # this should not raise error
        s = data.iloc[:, 0]
        # You can check the expected value based on the content in `docs/advanced/PIT.rst`
        expect = """
        instrument  datetime
        sh600519    2005-01-04         NaN
                    2007-04-30    0.090219
                    2007-08-17    0.139330
                    2007-10-23    0.245863
                    2008-03-03    0.347900
                    2008-03-13    0.395989
                    2008-04-22    0.100724
                    2008-08-28    0.249968
                    2008-10-27    0.334120
                    2009-03-25    0.390117
                    2009-04-21    0.102675
                    2009-08-07    0.230712
                    2009-10-26    0.300730
                    2010-04-02    0.335461
                    2010-04-26    0.083825
                    2010-08-12    0.200545
                    2010-10-29    0.260986
                    2011-03-21    0.307393
                    2011-04-25    0.097411
                    2011-08-31    0.248251
                    2011-10-18    0.318919
                    2012-03-23    0.403900
                    2012-04-11    0.403925
                    2012-04-26    0.112148
                    2012-08-10    0.264847
                    2012-10-26    0.370487
                    2013-03-29    0.450047
                    2013-04-18    0.099958
                    2013-09-02    0.210442
                    2013-10-16    0.304543
                    2014-03-25    0.394328
                    2014-04-25    0.083217
                    2014-08-29    0.164503
                    2014-10-30    0.234085
                    2015-04-21    0.078494
                    2015-08-28    0.137504
                    2015-10-23    0.201709
                    2016-03-24    0.264205
                    2016-04-21    0.073664
                    2016-08-29    0.136576
                    2016-10-31    0.188062
                    2017-04-17    0.244385
                    2017-04-25    0.080614
                    2017-07-28    0.151510
                    2017-10-26    0.254166
                    2018-03-28    0.329542
                    2018-05-02    0.088887
                    2018-08-02    0.170563
                    2018-10-29    0.255220
                    2019-03-29    0.344644
                    2019-04-25    0.094737
                    2019-07-15    0.000000
                    2019-07-18    0.175322
                    2019-10-16    0.255819
        Name: P($$roewa_q), dtype: float32
        """
        self.check_same(s[~s.duplicated().values], expect)

    def test_expr2(self):
        instruments = ["sh600519"]
        fields = ["P($$roewa_q)", "P($$yoyni_q)"]
        fields += ["P(($$roewa_q / $$yoyni_q) / Ref($$roewa_q / $$yoyni_q, 1) - 1)"]
        fields += ["P(Sum($$yoyni_q, 4))"]
        fields += ["$close", "P($$roewa_q) * $close"]
        data = D.features(instruments, fields, start_time="2019-01-01", end_time="2020-01-01", freq="day")


if __name__ == "__main__":
    unittest.main()
